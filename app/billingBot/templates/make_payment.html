{% extends "base.html" %}
{% block body %}
    <h3>{{ policy.policy_id }}</h3>
    <h4>{{ policy.paymentListMonth_number }}</h4>
    <h4>{{ policy.paymentListMonth_number.quote_number }}</h4>
    <h4>{{ policy.paymentListMonth_number.quote_number.pet_name }}</h4>
    <h3>{{ user.zipcode }}</h3>

    <div id="portalOneContainer"></div>

    <script type="text/javascript">
      !function($){var PortalOne=function(elem,portalUri){const modalStyles={display:"none",width:"100%",height:"100%",background:"none transparent",position:"fixed",top:0,left:0,"z-index":100500},options={frameborder:"0",allowTransparency:"true"},inlineStyles={width:"100%",position:"static"},self=this;var element=$(elem),portalOneFrame=$('<iframe style="display:none;"></iframe>'),parentDocumentOffset=0,toggleModal=function(){navigator.platform&&/iPad|iPhone|iPod/.test(navigator.platform)&&(0!==parentDocumentOffset?(document.body.scrollTop=parentDocumentOffset,parentDocumentOffset=0):(parentDocumentOffset=document.body.scrollTop,document.body.scrollTop=0))},subscribeToIframeEvents=function(params){portalOneFrame.one("error",(function(){element.trigger("portalOne.error",{description:"The payment portal loading failed"})})),portalOneFrame.one("load",(function(){!function(params){portalOneFrame[0].contentWindow.postMessage({messageType:"parameters",parameters:params},"*")}(params),portalOneFrame.show(),toggleModal(),element.trigger("portalOne.load")}))},initFrame=function(params,frameSrc){var isInlineModal=function(params){return params.displayMode&&"inline"===params.displayMode.toString().toLowerCase()}(params);!function(isInlineModal){portalOneFrame.removeAttr("style"),isInlineModal?portalOneFrame.css(inlineStyles):portalOneFrame.css(modalStyles),portalOneFrame.attr(options)}(isInlineModal),subscribeToIframeEvents(params),portalOneFrame.attr("src",frameSrc),function(isInlineModal){if(isInlineModal)element[0].style.position="";else{var ua=navigator.userAgent;(ua.indexOf("MSIE ")>-1||ua.indexOf("Trident/")>-1)&&(element[0].style.position="fixed",portalOneFrame[0].style.position="inherit")}}(isInlineModal)},startFrameWithParameters=function(params){var src=portalUri;src+="start-with-parameters?uniq="+(new Date).getTime(),initFrame(params,src)};this.savePaymentMethod=function(params){params.operation=function(paymentCategory){switch(paymentCategory){case"CreditCard":case"ECheck":case"UserSelect":return"savePaymentMethod";default:throw Error("Unsupported payment category.")}}(params.paymentCategory),startFrameWithParameters(params)},this.makePayment=function(params){params.operation=function(paymentCategory){switch(paymentCategory){case"CreditCard":case"ECheck":case"UserSelect":return"makePayment";default:throw Error("Unsupported payment category.")}}(params.paymentCategory),startFrameWithParameters(params)},this.managePaymentMethods=function(params){params.operation="managePaymentMethods",startFrameWithParameters(params)},this.enrollAutoPay=function(params){params.operation="enrollAutoPay",startFrameWithParameters(params)},this.quickPay=function(params){params.operation="quickPay",startFrameWithParameters(params)},this.run=function(params){var src=portalUri;src+="access-token/"+params.accessTokenId+"?sessionId="+params.sessionId,params.displayMode&&(src+="&displayMode="+params.displayMode),params.allowClosing&&(src+="&allowClosing="+params.allowClosing),initFrame(params,src)};var sendAcknowledgeNotification=function(){portalOneFrame[0].contentWindow.postMessage("acknowledge","*")},onMessageReceived=function(e){if(e.originalEvent.source===portalOneFrame[0].contentWindow){var height,portalOneMessage=function(messageData){if(!messageData)return null;var message={};try{message=$.parseJSON(messageData)}catch(e){return console.error("cannot parse message, error: "+e),null}return message.PortalOne?message.PortalOne:null}(e.originalEvent.data);if(null!=portalOneMessage)"Close"===portalOneMessage.Command&&(portalOneFrame.off("load"),portalOneFrame.off("error"),element.trigger("portalOne.unload"),portalOneFrame.hide(),toggleModal()),"UpdateContentHeight"===portalOneMessage.Command&&(height=portalOneMessage.Data.height,portalOneFrame.css("height",height)),portalOneMessage.Message&&("portalOne.paymentComplete"===portalOneMessage.Message&&portalOneMessage.Data&&(portalOneMessage.Data.acknowledge=sendAcknowledgeNotification),element.trigger(portalOneMessage.Message,portalOneMessage.Data)),portalOneMessage.Command&&self.applePay&&self.applePay.handleCommand(portalOneMessage)}};$(window).on("message",onMessageReceived),portalOneFrame.appendTo(element),self.applePay=new ApplePay(portalOneFrame[0].contentWindow)},ApplePay=function(frameContent){var eventType_applePayCheckComplete="portalOne.applePayCheckComplete",eventType_applePayMerchantValidateComplete="portalOne.validateMerchantComplete",eventType_applePayPaymentAuthorized="portalOne.applePayPaymentAuthorized",eventType_applePayPaymentCanceled="portalOne.applePayPaymentCanceled",commandType_ApplePayCheck="ApplePayCheck",commandType_ApplePayStart="ApplePayStart",commandType_ApplePayCompleteMerchantValidation="ApplePayCompleteMerchantValidation",commandType_ApplePayComplete="ApplePayComplete",commandType_ApplePayAbort="ApplePayAbort",sendMessageToFrame=function(messageType,data){const message={PortalOne:{Message:messageType,Data:data}};self.frameContent.postMessage(JSON.stringify(message),"*")},self={frameContent:frameContent,init:function(merchantIdentifier){"ApplePaySession"in window?ApplePaySession.canMakePaymentsWithActiveCard(merchantIdentifier).then((function(isApplePaySupported){sendMessageToFrame(eventType_applePayCheckComplete,isApplePaySupported)})):sendMessageToFrame(eventType_applePayCheckComplete,!1)},beginPayment:function(paymentRequest){self.session=new ApplePaySession(3,paymentRequest),self.session.onvalidatemerchant=function(event){var data={validationUrl:event.validationURL};sendMessageToFrame(eventType_applePayMerchantValidateComplete,data)},self.session.onpaymentauthorized=function(event){sendMessageToFrame(eventType_applePayPaymentAuthorized,event.payment)},self.session.oncancel=function(event){sendMessageToFrame(eventType_applePayPaymentCanceled)},self.session.begin()},completeMerchantValidation:function(merchantSession){self.session&&self.session.completeMerchantValidation(merchantSession)},completePayment:function(authorizationResult){self.session&&self.session.completePayment(authorizationResult)},abort:function(){if(self.session){try{this.session.abort()}catch(ex){}self.session=null}},handleCommand:function(command){switch(command.Command){case commandType_ApplePayCheck:self.init(command.Data.merchantIdentifier);break;case commandType_ApplePayStart:self.beginPayment(command.Data);break;case commandType_ApplePayComplete:self.completePayment(command.Data);break;case commandType_ApplePayCompleteMerchantValidation:self.completeMerchantValidation(command.Data);break;case commandType_ApplePayAbort:self.abort()}}};return self};$.fn.portalOne=function(){return this.each((function(){var element=$(this);if(!element.data("portalOne")){var portalOne=new PortalOne(this,"https://Stgportalone.processonepayments.com/GenericModalV2/");element.data("portalOne",portalOne)}}))},function(){var $portalOneButtons=$("button[data-toggle=portalone]"),$portalOneContainer=$("#portalOneContainer");if(0!==$portalOneButtons.length&&0!==$portalOneContainer.length){var portalOne=$portalOneContainer.portalOne().data("portalOne");$portalOneButtons.each((function(){var $button=$(this);$button.click((function(){var data=function(element){for(var attr,optionPrefix=/^data-option-/,data={},i=0;i<element.attributes.length;i++){if(attr=element.attributes[i],optionPrefix.test(attr.nodeName))data[attr.nodeName.replace(optionPrefix,"").replace(/-([a-z])/g,(function(match,char){return char.toUpperCase()}))]=attr.nodeValue}return data}(this),method=$button.attr("data-method");portalOne[method](data)}))}))}}()}(jQuery);

      $('#portalOneContainer').portalOne();

      $('#portalOneContainer').data('portalOne')
          .makePayment({
              'paymentCategory': 'CreditCard',
              'feeContext': 'PaymentWithFee',
              'amountContext': 'SelectOrEnterAmount',
              'minAmountDue': '{{ policy.paymentListMonth_number.quote_number.premium_cost }}',
              'accountBalance': '600.00',
              'billingZip': '{{ user.zipcode }}',
              'billingAddressStreet': '{{ user.address_1 }}, {{ user.city }}, {{ user.state }}',
              'policyHolderName': '{{ user.name }}',
              'clientReferenceData1': '{{ policy.policy_id }}',
              'confirmationDisplay': 'true',
              'saveOption': 'Save',
              'accountGroupCode': 'FallsLake',
              'acknowledgmentRequired': 'true',
              'acceptCreditCards': 'true',
              'sessionId': '{{ key.PortalOneSessionKey }}'
      });
    </script>
{% endblock %}
